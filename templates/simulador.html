{% extends "base.html" %}

{% block title %}Simulador - Prism{% endblock %}

{% block extra_styles %}

.simulator-layout {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - 60px);
    background: linear-gradient(135deg, #128c7e 0%, #075e54 100%);
    padding: 20px;
}

.phone-container {
    width: 375px;
    height: 667px;
    background: white;
    border-radius: 25px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    position: relative;
}

.phone-header {
    background: #075e54;
    color: white;
    padding: 15px 20px;
    text-align: center;
    font-weight: 500;
}

/* Selector de cliente */
.client-selector {
    background: #f0f2f5;
    padding: 15px 20px;
    border-bottom: 1px solid #e5e7eb;
    margin-right: 80px;
    border-radius: 10px;
}

.client-selector h3 {
    font-size: 14px;
    margin-bottom: 10px;
    color: #333;
}

.client-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.client-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
}

.client-card:hover {
    border-color: #075e54;
    transform: translateY(-2px);
}

.client-card.active {
    border-color: #075e54;
    background: #e8f5e8;
}

.client-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #075e54;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    font-weight: bold;
    font-size: 16px;
}

.client-name {
    font-size: 12px;
    font-weight: 500;
    color: #333;
    margin-bottom: 2px;
}

.client-id {
    font-size: 10px;
    color: #666;
}

/* Chat area */
.chat-area {
    flex: 1;
    display: flex;
    overflow-y: auto;
    flex-direction: column;
    background: #e5ddd5;
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><rect width="40" height="40" fill="%23e5ddd5"/><circle cx="20" cy="20" r="1" fill="%23ffffff" opacity="0.1"/></svg>');
}

.messages-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.message {
    margin-bottom: 15px;
    display: flex;
}

.message.sent {
    justify-content: flex-end;
}

.message.received {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 80%;
    padding: 8px 12px;
    border-radius: 8px;
    position: relative;
    word-wrap: break-word;
}

.message.sent .message-bubble {
    background: #dcf8c6;
    border-bottom-right-radius: 2px;
}

.message.received .message-bubble {
    background: white;
    border-bottom-left-radius: 2px;
}

.message-time {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
    text-align: right;
}

.message.received .message-time {
    text-align: left;
}

.ai-badge {
    background: #25d366;
    color: white;
    font-size: 9px;
    padding: 1px 4px;
    border-radius: 3px;
    margin-left: 5px;
}

/* Mensajes del sistema */
.message.system {
    justify-content: center;
    margin-bottom: 20px;
}

.message.system .message-bubble {
    background: #e3f2fd;
    color: #1565c0;
    border: 1px solid #bbdefb;
    max-width: 90%;
    text-align: center;
    font-size: 13px;
    border-radius: 15px;
}

.message.system .message-time {
    text-align: center;
    margin-top: 8px;
    font-size: 10px;
    opacity: 0.8;
}

/* Estilos para archivos adjuntos */
.file-attachment {
    background: #f0f2f5;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 10px;
    border: 1px solid #e5e7eb;
    cursor: pointer;
    transition: background 0.2s;
}

.file-attachment:hover {
    background: #e8f5e8;
}

.file-icon {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
}

.file-icon.image {
    background: #4CAF50;
}

.file-icon.document {
    background: #2196F3;
}

.file-icon.pdf {
    background: #f44336;
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-size: 13px;
    font-weight: 500;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-size {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

.file-preview {
    max-width: 100%;
    border-radius: 8px;
    margin-bottom: 5px;
}

.file-preview img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    cursor: pointer;
}

/* Input area actualizada */
.input-area {
    background: #f0f2f5;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.input-container {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    background: white;
    border-radius: 20px;
    padding: 5px 15px;
}

.message-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 14px;
    padding: 8px 0;
    background: transparent;
}

.message-input:disabled {
    background: transparent;
    color: #999;
}

.attachment-button {
    width: 30px;
    height: 30px;
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    border-radius: 50%;
    transition: all 0.2s;
    margin-right: 5px;
}

.attachment-button:hover:not(:disabled) {
    background: #f0f2f5;
    color: #075e54;
}

.attachment-button:disabled {
    color: #ccc;
    cursor: not-allowed;
}

.send-button {
    width: 40px;
    height: 40px;
    background: #075e54;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s;
}

.send-button:hover:not(:disabled) {
    background: #128c7e;
}

.send-button:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* Input de archivo oculto */
.file-input {
    display: none;
}

/* Preview de archivos antes de enviar */
.file-preview-container {
    background: #f9f9f9;
    border-top: 1px solid #e5e7eb;
    padding: 10px 15px;
    display: none;
    gap: 10px;
}

.file-preview-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: white;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.file-preview-item .file-icon {
    width: 30px;
    height: 30px;
    font-size: 14px;
}

.remove-file {
    background: #f44336;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

/* Estado sin cliente seleccionado */
.no-client-selected {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #666;
    text-align: center;
    padding: 40px;
}

.no-client-selected .icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* Indicador de conexi√≥n */
.connection-status {
    position: absolute;
    top: 23px;
    right: 120px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #25d366;
    border: 2px solid white;
}

.connection-status.disconnected {
    background: #f44336;
}

/* Animaci√≥n de escritura */
.typing-indicator {
    display: none;
    align-items: center;
    justify-content: flex-start;
    margin-bottom: 15px;
}

.typing-bubble {
    background: white;
    padding: 8px 12px;
    border-radius: 8px;
    border-bottom-left-radius: 2px;
}

.typing-dots {
    display: flex;
    gap: 3px;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: #666;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
    }
    30% {
        transform: translateY(-10px);
        opacity: 1;
    }
}

/* Status messages */
.status-message {
    position: absolute;
    bottom: 150px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 15px;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 1000;
}

.status-message.show {
    opacity: 1;
}

/* Responsive para desktop */
@media (min-width: 768px) {
    .simulator-layout {
        background: linear-gradient(135deg, #128c7e 0%, #075e54 100%);
    }

    .phone-container {
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
}

/* Responsive m√≥vil */
@media (max-width: 400px) {
    .simulator-layout {
        padding: 10px;
    }

    .phone-container {
        width: 100%;
        max-width: 375px;
        height: calc(100vh - 80px);
        border-radius: 15px;
    }
}

{% endblock %}

{% block content %}
<div class="simulator-layout">
    <div class="client-selector">
        <h3>Selecciona un cliente para simular:</h3>
        <div class="client-grid">
            <div class="client-card" data-client-id="4" data-client-name="Ana Mart√≠nez" data-client-type="nuevo">
                <div class="client-avatar">AM</div>
                <div class="client-name">Ana Mart√≠nez</div>
                <div class="client-id">ID: 4</div>
            </div>
            <div class="client-card" data-client-id="5" data-client-name="Diego L√≥pez" data-client-type="nuevo">
                <div class="client-avatar">DL</div>
                <div class="client-name">Diego L√≥pez</div>
                <div class="client-id">ID: 5</div>
            </div>
            <div class="client-card" data-client-id="6" data-client-name="Sofia Herrera" data-client-type="nuevo">
                <div class="client-avatar">SH</div>
                <div class="client-name">Sofia Herrera</div>
                <div class="client-id">ID: 6</div>
            </div>
            <div class="client-card" data-client-id="7" data-client-name="Miguel Torres" data-client-type="nuevo">
                <div class="client-avatar">MT</div>
                <div class="client-name">Miguel Torres</div>
                <div class="client-id">ID: 7</div>
            </div>
        </div>
    </div>
    <div class="phone-container">
        <div class="phone-header">
            <div>Chat Biplan</div>
            <div class="connection-status" id="connectionStatus"></div>
        </div>
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <div class="no-client-selected" id="noClientSelected">
                    <div class="icon">üí¨</div>
                    <h3>Selecciona un cliente</h3>
                    <p>Elige un cliente de la lista para comenzar a simular la conversaci√≥n</p>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-bubble">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>

            <!-- Preview de archivos antes de enviar -->
            <div class="file-preview-container" id="filePreviewContainer">
                <!-- Los archivos seleccionados aparecer√°n aqu√≠ -->
            </div>

            <div class="input-area">
                <div class="input-container">
                    <!-- Bot√≥n de adjuntar archivo -->
                    <button class="attachment-button" id="attachmentButton" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                        </svg>
                    </button>

                    <input
                        type="text"
                        class="message-input"
                        id="messageInput"
                        placeholder="Selecciona un cliente primero..."
                        disabled
                    >
                </div>

                <!-- Input oculto para archivos -->
                <input
                    type="file"
                    class="file-input"
                    id="fileInput"
                    multiple
                    accept="image/*,.pdf,.doc,.docx,.txt,.xlsx,.xls"
                >

                <button class="send-button" id="sendButton" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Status indicator -->
        <div class="status-message" id="statusMessage"></div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<!-- Incluir el cliente WebSocket -->
<script src="/static/js/chat-websocket.js"></script>
{% endblock %}

{% block scripts %}
    <script>
        // Variables globales
        let currentClient = null;
        let chatClient = null;
        let isConnected = false;
        let selectedFiles = [];

        // Clientes predefinidos
        const clients = {
            4: { name: "Ana Mart√≠nez", avatar: "AM", type: "nuevo" },
            5: { name: "Diego L√≥pez", avatar: "DL", type: "nuevo" },
            6: { name: "Sofia Herrera", avatar: "SH", type: "nuevo" },
            7: { name: "Miguel Torres", avatar: "MT", type: "nuevo" }
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log('üöÄ Iniciando Simulador de Cliente');

            // Event listeners para selecci√≥n de cliente
            document.querySelectorAll('.client-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectClient(this.dataset.clientId);
                });
            });

            // Event listener para env√≠o de mensajes
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !this.disabled) {
                    sendMessage();
                }
            });

            document.getElementById('sendButton').addEventListener('click', function() {
                if (!this.disabled) {
                    sendMessage();
                }
            });

            // Event listeners para archivos
            document.getElementById('attachmentButton').addEventListener('click', function() {
                if (!this.disabled) {
                    document.getElementById('fileInput').click();
                }
            });

            document.getElementById('fileInput').addEventListener('change', function(e) {
                handleFileSelection(e.target.files);
            });

            console.log('‚úÖ Simulador inicializado');
        }

        function selectClient(clientId) {
            console.log(`üéØ Seleccionando cliente ${clientId}`);

            // Actualizar UI
            document.querySelectorAll('.client-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-client-id="${clientId}"]`).classList.add('active');

            // Establecer cliente actual
            currentClient = clientId;
            const client = clients[clientId];

            // Desconectar cliente anterior si existe
            if (chatClient) {
                chatClient.disconnect();
            }

            // Inicializar WebSocket para este cliente
            if (window.PrismChat && window.PrismChat.isWebSocketSupported()) {
                chatClient = window.PrismChat.createMobileClient(clientId, client.name);

                // Configurar callbacks
                chatClient.onConnect = handleWebSocketConnect;
                chatClient.onDisconnect = handleWebSocketDisconnect;
                chatClient.onMessage = handleWebSocketMessage;
                chatClient.onError = handleWebSocketError;

                console.log(`‚úÖ WebSocket iniciado para ${client.name}`);
            } else {
                console.error('‚ùå WebSocket no soportado');
                showStatus('WebSocket no soportado', 'error');
            }

            // Habilitar controles
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const attachmentButton = document.getElementById('attachmentButton');

            messageInput.disabled = false;
            messageInput.placeholder = `Escribiendo como ${client.name}...`;
            sendButton.disabled = false;
            attachmentButton.disabled = false;

            // Ocultar mensaje de no selecci√≥n
            document.getElementById('noClientSelected').style.display = 'none';

            // Limpiar mensajes previos
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            // Limpiar archivos seleccionados
            clearSelectedFiles();

            // Focus en input
            messageInput.focus();

            showStatus(`Conectado como ${client.name}`, 'success');
        }

        // Manejo de archivos
        function handleFileSelection(files) {
            console.log('üìé Archivos seleccionados:', files.length);

            for (let file of files) {
                if (selectedFiles.length >= 5) {
                    showStatus('M√°ximo 5 archivos por mensaje', 'warning');
                    break;
                }

                if (file.size > 10 * 1024 * 1024) { // 10MB
                    showStatus(`${file.name} es muy grande (m√°x. 10MB)`, 'warning');
                    continue;
                }

                selectedFiles.push(file);
            }

            updateFilePreview();

            // Reset input
            document.getElementById('fileInput').value = '';
        }

        function updateFilePreview() {
            const container = document.getElementById('filePreviewContainer');

            if (selectedFiles.length === 0) {
                container.style.display = 'none';
                container.innerHTML = '';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'file-preview-item';

                const fileIcon = getFileIcon(file);
                const fileName = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;
                const fileSize = formatFileSize(file.size);

                previewDiv.innerHTML = `
                    <div class="file-icon ${fileIcon.class}">
                        ${fileIcon.icon}
                    </div>
                    <div class="file-info">
                        <div class="file-name">${fileName}</div>
                        <div class="file-size">${fileSize}</div>
                    </div>
                    <button class="remove-file" onclick="removeFile(${index})">√ó</button>
                `;

                container.appendChild(previewDiv);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilePreview();
        }

        function clearSelectedFiles() {
            selectedFiles = [];
            updateFilePreview();
        }

        function getFileIcon(file) {
            const type = file.type;
            const extension = file.name.split('.').pop().toLowerCase();

            if (type.startsWith('image/')) {
                return { class: 'image', icon: 'üñºÔ∏è' };
            } else if (type === 'application/pdf' || extension === 'pdf') {
                return { class: 'pdf', icon: 'üìÑ' };
            } else if (type.includes('document') || type.includes('text') ||
                       ['doc', 'docx', 'txt', 'rtf'].includes(extension)) {
                return { class: 'document', icon: 'üìù' };
            } else if (type.includes('spreadsheet') ||
                       ['xls', 'xlsx', 'csv'].includes(extension)) {
                return { class: 'document', icon: 'üìä' };
            } else {
                return { class: 'document', icon: 'üìé' };
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Funci√≥n para convertir archivo a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // Manejar conexi√≥n WebSocket
        function handleWebSocketConnect() {
            console.log('‚úÖ Cliente conectado al WebSocket');
            isConnected = true;
            updateConnectionStatus(true);
            showStatus('Conectado al servidor', 'success');
        }

        // Manejar desconexi√≥n WebSocket
        function handleWebSocketDisconnect() {
            console.log('‚ùå Cliente desconectado del WebSocket');
            isConnected = false;
            updateConnectionStatus(false);
            showStatus('Desconectado del servidor', 'error');
        }

        // Manejar errores WebSocket
        function handleWebSocketError(error) {
            console.error('‚ùå Error WebSocket:', error);
            showStatus('Error de conexi√≥n', 'error');
        }

        // Manejar mensajes del WebSocket
        function handleWebSocketMessage(data) {
            console.log('üì® Cliente recibi√≥:', data);

            switch(data.type) {
                case 'admin_response':
                    handleAdminResponse(data);
                    break;
                case 'ai_response':
                    handleAIResponse(data);
                    break;
                case 'transfer_notification':
                    handleTransferNotification(data);
                    break;
                case 'connection_established':
                    console.log('üéâ Conexi√≥n establecida:', data.message);
                    break;
                default:
                    console.log('ü§∑ Tipo de mensaje no manejado:', data.type);
            }
        }

        // Manejar respuesta del administrador
        function handleAdminResponse(data) {
            console.log('üë®‚Äçüíº Respuesta del admin recibida:', data);

            if (data.message) {
                displayMessage(data.message, 'received');
            }
        }

        // Manejar respuesta de la IA
        function handleAIResponse(data) {
            console.log('ü§ñ Respuesta de IA recibida:', data);

            if (data.message) {
                displayMessage(data.message, 'received');
            }
        }

        // Manejar notificaci√≥n de transferencia
        function handleTransferNotification(data) {
            console.log('üîÑ Notificaci√≥n de transferencia:', data);

            if (data.message) {
                displayMessage(data.message, 'system');
            }

            showStatus(`Transferido a ${data.transfer_area}`, 'info');
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();

            if ((!messageText && selectedFiles.length === 0) || !currentClient || !chatClient || !isConnected) {
                if (!isConnected) {
                    showStatus('No conectado al servidor', 'error');
                }
                return;
            }

            console.log(`üì§ Enviando mensaje: ${messageText} con ${selectedFiles.length} archivos`);

            try {
                // Preparar datos del mensaje
                const messageData = {
                    type: "new_client_message",
                    client_id: currentClient,
                    client_name: clients[currentClient].name,
                    message: messageText,
                    timestamp: new Date().toISOString(),
                    files: []
                };

                // Procesar archivos si hay
                if (selectedFiles.length > 0) {
                    showStatus('Procesando archivos...', 'info');

                    for (let file of selectedFiles) {
                        try {
                            const base64Data = await fileToBase64(file);
                            messageData.files.push({
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                data: base64Data
                            });
                        } catch (error) {
                            console.error('Error procesando archivo:', file.name, error);
                            showStatus(`Error procesando ${file.name}`, 'error');
                        }
                    }
                }

                // Mostrar mensaje localmente
                const displayMessageData = {
                    content: messageText,
                    sender: clients[currentClient].name,
                    timestamp: new Date().toISOString(),
                    message_type: 'cliente',
                    files: messageData.files.map(f => ({
                        name: f.name,
                        type: f.type,
                        size: f.size,
                        data: f.data
                    }))
                };

                displayMessage(displayMessageData, 'sent');

                // Enviar a trav√©s del WebSocket
                chatClient.send(messageData);

                // Limpiar input y archivos
                input.value = '';
                clearSelectedFiles();

                showStatus('Mensaje enviado', 'success');

            } catch (error) {
                console.error('Error enviando mensaje:', error);
                showStatus('Error enviando mensaje', 'error');
            }
        }

        function displayMessage(message, type) {
            const container = document.getElementById('messagesContainer');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const timeString = new Date(message.timestamp).toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });

            let aiBadge = '';
            let senderIcon = '';

            if (message.message_type === 'ia') {
                aiBadge = '<span class="ai-badge">IA</span>';
                senderIcon = 'ü§ñ ';
            } else if (message.message_type === 'sistema') {
                senderIcon = 'üîÑ ';
                messageDiv.className = `message system`;
            } else if (message.is_derivation) {
                senderIcon = 'üìã ';
                messageDiv.className = `message system`;
            }

            let filesHtml = '';
            if (message.files && message.files.length > 0) {
                filesHtml = renderMessageFiles(message.files);
            }

            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${filesHtml}
                    ${message.content ? `<div>${message.content}</div>` : ''}
                    <div class="message-time">${senderIcon}${timeString}${aiBadge}</div>
                </div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function renderMessageFiles(files) {
            let html = '';

            files.forEach(file => {
                const fileIcon = getFileIconByType(file.type, file.name);
                const fileSize = formatFileSize(file.size);

                if (file.type && file.type.startsWith('image/') && file.data) {
                    // Vista previa para im√°genes
                    html += `
                        <div class="file-preview">
                            <img src="data:${file.type};base64,${file.data}"
                                 alt="${file.name}"
                                 onclick="openImagePreview('data:${file.type};base64,${file.data}', '${file.name}')" />
                        </div>
                    `;
                } else {
                    // Vista para otros archivos
                    html += `
                        <div class="file-attachment" onclick="downloadFile('${file.data}', '${file.name}', '${file.type}')">
                            <div class="file-icon ${fileIcon.class}">
                                ${fileIcon.icon}
                            </div>
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${fileSize}</div>
                            </div>
                        </div>
                    `;
                }
            });

            return html;
        }

        function getFileIconByType(type, filename) {
            const extension = filename.split('.').pop().toLowerCase();

            if (type && type.startsWith('image/')) {
                return { class: 'image', icon: 'üñºÔ∏è' };
            } else if (type === 'application/pdf' || extension === 'pdf') {
                return { class: 'pdf', icon: 'üìÑ' };
            } else if (type && (type.includes('document') || type.includes('text')) ||
                       ['doc', 'docx', 'txt', 'rtf'].includes(extension)) {
                return { class: 'document', icon: 'üìù' };
            } else if (type && type.includes('spreadsheet') ||
                       ['xls', 'xlsx', 'csv'].includes(extension)) {
                return { class: 'document', icon: 'üìä' };
            } else {
                return { class: 'document', icon: 'üìé' };
            }
        }

        function openImagePreview(src, name) {
            // Crear modal para vista previa de imagen
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;

            modal.innerHTML = `
                <div style="max-width: 90%; max-height: 90%; text-align: center;">
                    <img src="${src}" alt="${name}" style="max-width: 100%; max-height: 100%; border-radius: 8px;" />
                    <div style="color: white; margin-top: 10px; font-size: 14px;">${name}</div>
                    <div style="color: #ccc; margin-top: 5px; font-size: 12px;">Toca para cerrar</div>
                </div>
            `;

            modal.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            document.body.appendChild(modal);
        }

        function downloadFile(base64Data, filename, type) {
            try {
                const link = document.createElement('a');
                link.href = `data:${type};base64,${base64Data}`;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showStatus(`Descargando ${filename}`, 'success');
            } catch (error) {
                console.error('Error descargando archivo:', error);
                showStatus('Error descargando archivo', 'error');
            }
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.classList.remove('disconnected');
            } else {
                status.classList.add('disconnected');
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message show ${type}`;

            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 3000);
        }

        // Funciones de utilidad para debugging/testing
        window.BiplanClientSimulator = {
            selectClient,
            sendMessage,
            getCurrentClient: () => currentClient,
            isConnected: () => isConnected,
            getClients: () => clients,
            getSelectedFiles: () => selectedFiles,
            clearFiles: clearSelectedFiles
        };
    </script>
{% endblock %}