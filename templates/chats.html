{% extends "base.html" %}

{% block title %}Chats - Prism{% endblock %}

{% block extra_styles %}
/* Layout espec√≠fico para chats */
.chat-layout {
    display: flex;
    height: calc(100vh - 60px);
    background: #f0f2f5;
}

/* Sidebar con lista de chats */
.sidebar {
    width: 300px;
    background: white;
    border-right: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
    background: #075e54;
    color: white;
    position: relative;
}

.sidebar-header h2 {
    font-size: 18px;
    font-weight: 500;
}

.connection-indicator {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #25d366;
    border: 2px solid white;
}

.connection-indicator.disconnected {
    background: #f44336;
}

.chat-list {
    flex: 1;
    overflow-y: auto;
}

.chat-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f1f1f1;
    cursor: pointer;
    transition: background 0.2s;
    position: relative;
}

.chat-item:hover {
    background: #f5f5f5;
}

.chat-item.active {
    background: #e3f2fd;
}

.chat-item h4 {
    font-size: 14px;
    margin-bottom: 5px;
    color: #333;
}

.chat-item p {
    font-size: 12px;
    color: #666;
}

.chat-status {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    margin-left: 8px;
}

.status-ai {
    background: #e8f5e8;
    color: #2e7d32;
}

.status-human {
    background: #fff3e0;
    color: #ef6c00;
}

.chat-item.has-new-message {
    background: #e3f2fd;
    border-left: 4px solid #075e54;
}

.chat-item.has-new-message::after {
    content: '‚óè';
    color: #075e54;
    font-size: 12px;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
}

/* Panel principal */
.main-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.chat-header {
    padding: 15px 20px;
    background: #075e54;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-header h3 {
    font-size: 16px;
    font-weight: 500;
}

.config-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background 0.2s;
}

.config-btn:hover {
    background: rgba(255,255,255,0.1);
}

/* Chat container */
.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
}

.messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f8f9fa;
}

.message {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
}

.message.sent {
    justify-content: flex-end;
}

.message.received {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    position: relative;
}

.message.sent .message-bubble {
    background: #075e54;
    color: white;
}

.message.received .message-bubble {
    background: white;
    border: 1px solid #e5e7eb;
}

.message-info {
    font-size: 11px;
    margin-top: 5px;
    opacity: 0.7;
}

.message.sent .message-info {
    text-align: right;
}

/* Mensajes del sistema */
.message.system {
    justify-content: center;
    margin-bottom: 20px;
}

.message.system .message-bubble {
    background: #e3f2fd;
    color: #1565c0;
    border: 1px solid #bbdefb;
    max-width: 90%;
    text-align: center;
    font-size: 13px;
    border-radius: 15px;
}

.message.system .message-info {
    text-align: center;
    margin-top: 8px;
    font-size: 10px;
    opacity: 0.8;
}

/* Input area */
.input-area {
    padding: 15px 20px;
    background: white;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 10px;
}

.message-input {
    flex: 1;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 20px;
    outline: none;
    font-size: 14px;
}

.message-input:disabled {
    background: #f5f5f5;
    color: #999;
}

.send-btn {
    background: #075e54;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

.send-btn:hover:not(:disabled) {
    background: #128c7e;
}

.send-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* Estado sin chat seleccionado */
.no-chat-selected {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #666;
    text-align: center;
    padding: 40px;
}

.no-chat-selected .icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* Loading state */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #666;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #075e54;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Error messages */
.error-message {
    background: #ffebee;
    color: #c62828;
    padding: 10px 15px;
    border-radius: 4px;
    margin: 10px 20px;
    border-left: 4px solid #c62828;
}

/* Status indicators */
.status-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #075e54;
    color: white;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 12px;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s;
}

.status-indicator.show {
    opacity: 1;
}

/* Responsive */
@media (max-width: 768px) {
    .chat-layout {
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        height: 40%;
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .main-panel {
        height: 60%;
    }
}
{% endblock %}

{% block content %}
<!-- Layout espec√≠fico para chats que ocupa toda la altura -->
<div class="chat-layout">
    <!-- Sidebar con lista de chats -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Conversaciones Activas</h2>
            <div class="connection-indicator" id="connectionIndicator"></div>
        </div>
        <div class="chat-list" id="chatList">
            <div class="loading">
                <div class="spinner"></div>
                Cargando conversaciones...
            </div>
        </div>
    </div>

    <!-- Panel principal -->
    <div class="main-panel">
        <div class="chat-header">
            <h3 id="currentChatTitle">Selecciona una conversaci√≥n</h3>
            <button class="config-btn" onclick="refreshConversations()">üîÑ Actualizar</button>
        </div>

        <div class="chat-container">
            <div class="messages" id="messagesContainer">
                <div class="no-chat-selected" id="noChatSelected">
                    <div class="icon">üí¨</div>
                    <h3>Bienvenido al Panel de Chat</h3>
                    <p>Selecciona una conversaci√≥n para comenzar a responder</p>
                </div>
            </div>

            <div class="input-area">
                <input type="text" class="message-input" placeholder="Selecciona una conversaci√≥n para responder..." id="messageInput" disabled>
                <button class="send-btn" onclick="sendMessage()" id="sendButton" disabled>Enviar</button>
            </div>
        </div>
    </div>
</div>

<!-- Status indicator -->
<div class="status-indicator" id="statusIndicator"></div>
{% endblock %}

{% block extra_head %}
<!-- Incluir el cliente WebSocket -->
<script src="/static/js/chat-websocket.js"></script>
{% endblock %}

{% block scripts %}
<script>
    // Variables globales
    let chatClient = null;
    let currentConversationId = null;
    let conversationData = {};
    let isConnected = false;

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
    });

    function initializeApp() {
        console.log('üöÄ Iniciando Panel de Chat Admin');

        // Inicializar cliente WebSocket
        if (window.PrismChat && window.PrismChat.isWebSocketSupported()) {
            chatClient = window.PrismChat.createAdminClient();

            // Configurar callbacks espec√≠ficos del admin
            chatClient.onConnect = handleWebSocketConnect;
            chatClient.onDisconnect = handleWebSocketDisconnect;
            chatClient.onMessage = handleWebSocketMessage;
            chatClient.onError = handleWebSocketError;

            console.log('‚úÖ Cliente WebSocket iniciado para admin');
        } else {
            console.error('‚ùå WebSocket no soportado');
            showError('Tu navegador no soporta WebSocket');
        }

        // Event listener para el input de mensaje
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !this.disabled) {
                sendMessage();
            }
        });

        console.log('‚úÖ Panel de chat inicializado');
    }

    // Manejar conexi√≥n WebSocket
    function handleWebSocketConnect() {
        console.log('‚úÖ Admin conectado al WebSocket');
        isConnected = true;
        updateConnectionIndicator(true);
        showStatus('Conectado al servidor', 'success');

        // Solicitar conversaciones activas
        setTimeout(() => {
            requestActiveConversations();
        }, 500);
    }

    // Manejar desconexi√≥n WebSocket
    function handleWebSocketDisconnect() {
        console.log('‚ùå Admin desconectado del WebSocket');
        isConnected = false;
        updateConnectionIndicator(false);
        showStatus('Desconectado del servidor', 'error');
    }

    // Manejar errores WebSocket
    function handleWebSocketError(error) {
        console.error('‚ùå Error WebSocket:', error);
        showError('Error de conexi√≥n con el servidor');
    }

    // Manejar respuesta de IA
    function handleAIResponse(data) {
        console.log('ü§ñ Respuesta de IA recibida:', data);

        // Si es la conversaci√≥n activa, mostrar el mensaje
        if (currentConversationId === data.conversation_id) {
            displayMessage(data.message, 'received');
        }
    }

    // Manejar notificaci√≥n de transferencia
    function handleTransferNotification(data) {
        console.log('üîÑ Notificaci√≥n de transferencia:', data);

        // Si es la conversaci√≥n activa, mostrar el mensaje
        if (currentConversationId === data.conversation_id) {
            displayMessage(data.message, 'system');
        }

        // Actualizar el estado de la conversaci√≥n en la lista
        const chatItem = document.querySelector(`[data-conversation-id="${data.conversation_id}"]`);
        if (chatItem) {
            const statusElement = chatItem.querySelector('.chat-status');
            if (statusElement) {
                statusElement.textContent = 'Humano';
                statusElement.className = 'chat-status status-human';
            }
        }
    }

    // Manejar mensajes del WebSocket
    function handleWebSocketMessage(data) {
        console.log('üì® Admin recibi√≥:', data);

        switch(data.type) {
            case 'new_message':
                handleNewMessage(data);
                break;
            case 'admin_response':
                handleAdminResponse(data);
                break;
            case 'ai_response':
                handleAIResponse(data);
                break;
            case 'transfer_notification':
                handleTransferNotification(data);
                break;
            case 'active_conversations':
                handleActiveConversations(data);
                break;
            case 'conversation_history':
                handleConversationHistory(data);
                break;
            case 'error':
                showError(data.message);
                break;
            default:
                console.log('ü§∑ Tipo de mensaje no manejado:', data.type);
        }
    }

    // Solicitar conversaciones activas
    function requestActiveConversations() {
        if (chatClient && isConnected) {
            console.log('üìã Solicitando conversaciones activas');
            chatClient.send({
                type: "get_active_conversations"
            });
        }
    }

    // Manejar lista de conversaciones activas
    function handleActiveConversations(data) {
        console.log('üìã Conversaciones activas recibidas:', data.conversations);

        const chatList = document.getElementById('chatList');

        if (data.conversations.length === 0) {
            chatList.innerHTML = `
                <div class="no-chat-selected" style="padding: 40px 20px;">
                    <div class="icon">üí¨</div>
                    <h4>No hay conversaciones activas</h4>
                    <p>Las conversaciones aparecer√°n aqu√≠ cuando los clientes env√≠en mensajes</p>
                </div>
            `;
            return;
        }

        // Renderizar conversaciones
        let chatListHTML = '';
        data.conversations.forEach(conv => {
            conversationData[conv.conversation_id] = conv;

            const isActive = currentConversationId === conv.conversation_id;
            const statusClass = conv.status === 'ia_respondiendo' ? 'status-ai' : 'status-human';
            const statusText = conv.status === 'ia_respondiendo' ? 'IA' : 'Humano';

            chatListHTML += `
                <div class="chat-item ${isActive ? 'active' : ''}"
                     data-conversation-id="${conv.conversation_id}"
                     data-client-id="${conv.client_id}"
                     onclick="selectConversation(${conv.conversation_id})">
                    <h4>${conv.client_name} <span class="chat-status ${statusClass}">${statusText}</span></h4>
                    <p>Conversaci√≥n activa</p>
                </div>
            `;
        });

        chatList.innerHTML = chatListHTML;
    }

    // Manejar nuevo mensaje de cliente
    function handleNewMessage(data) {
        console.log('üí¨ Nuevo mensaje recibido:', data);

        // Actualizar o crear chat en la lista
        updateOrCreateChatItem(data.client_id, data.client_name, data.message.content);

        // Si es la conversaci√≥n activa, mostrar el mensaje
        if (currentConversationId === data.conversation_id) {
            displayMessage(data.message, 'received');
        }

        // Reproducir sonido de notificaci√≥n
        playNotificationSound();

        // Mostrar notificaci√≥n desktop
        showDesktopNotification(data.client_name, data.message.content);
    }

    // Manejar respuesta del admin (confirmaci√≥n)
    function handleAdminResponse(data) {
        console.log('üë®‚Äçüíº Respuesta de admin confirmada:', data);

        // Si es la conversaci√≥n activa, mostrar el mensaje
        if (currentConversationId === data.conversation_id) {
            displayMessage(data.message, 'sent');
        }
    }

    // Manejar historial de conversaci√≥n
    function handleConversationHistory(data) {
        console.log('üìú Historial recibido:', data);

        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = '';

        if (data.messages.length === 0) {
            messagesContainer.innerHTML = `
                <div class="no-chat-selected">
                    <div class="icon">üí¨</div>
                    <h3>Sin mensajes</h3>
                    <p>Esta conversaci√≥n no tiene mensajes a√∫n</p>
                </div>
            `;
            return;
        }

        // Mostrar mensajes
        data.messages.forEach(message => {
            const type = message.message_type === 'cliente' ? 'received' : 'sent';
            displayMessage(message, type);
        });
    }

    // Seleccionar conversaci√≥n
    function selectConversation(conversationId) {
        console.log(`üéØ Seleccionando conversaci√≥n ${conversationId}`);

        // Actualizar UI
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
            item.classList.remove('has-new-message');
        });

        const selectedItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
        }

        // Actualizar variables
        currentConversationId = conversationId;
        const conv = conversationData[conversationId];

        if (conv) {
            document.getElementById('currentChatTitle').textContent = conv.client_name;
        }

        // Habilitar input
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        messageInput.disabled = false;
        messageInput.placeholder = 'Escribe tu respuesta...';
        sendButton.disabled = false;

        // Ocultar mensaje de no selecci√≥n
        document.getElementById('noChatSelected').style.display = 'none';

        // Solicitar historial
        if (chatClient && isConnected) {
            chatClient.send({
                type: "get_conversation_history",
                conversation_id: conversationId,
                limit: 50
            });

            chatClient.send({
                type: "join_conversation",
                conversation_id: conversationId
            });
        }

        // Focus en input
        messageInput.focus();
    }

    // Enviar mensaje
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (!message || !currentConversationId || !chatClient || !isConnected) {
            return;
        }

        console.log(`üì§ Enviando mensaje: ${message}`);

        // Enviar a trav√©s del WebSocket
        chatClient.send({
            type: "admin_response",
            conversation_id: currentConversationId,
            message: message,
            admin_name: 'Administrador',
            timestamp: new Date().toISOString()
        });

        // Limpiar input
        input.value = '';
    }

    // Mostrar mensaje en el chat
    function displayMessage(message, type) {
        const messagesContainer = document.getElementById('messagesContainer');

        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;

        const timeString = new Date(message.timestamp).toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
        });

        let aiIndicator = '';
        let senderIcon = '';

        if (message.message_type === 'ia') {
            aiIndicator = '<span class="ai-indicator">IA</span>';
            senderIcon = 'ü§ñ ';
        } else if (message.message_type === 'sistema') {
            senderIcon = 'üîÑ ';
            messageElement.className = `message system`;
        } else if (message.is_derivation) {
            senderIcon = 'üìã ';
            messageElement.className = `message system`;
        }

        messageElement.innerHTML = `
            <div class="message-bubble">
                ${message.content}
                <div class="message-info">
                    ${senderIcon}${message.sender} ‚Ä¢ ${timeString} ${aiIndicator}
                </div>
            </div>
        `;

        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Actualizar o crear item en la lista de chats
    function updateOrCreateChatItem(clientId, clientName, lastMessage) {
        let chatItem = document.querySelector(`[data-client-id="${clientId}"]`);

        if (!chatItem) {
            // Si no existe, solicitar actualizaci√≥n de conversaciones
            requestActiveConversations();
            return;
        }

        // Actualizar mensaje preview
        const messagePreview = chatItem.querySelector('p');
        if (messagePreview) {
            messagePreview.textContent = lastMessage.substring(0, 50) +
                (lastMessage.length > 50 ? '...' : '');
        }

        // Mover al top de la lista
        const chatList = chatItem.parentNode;
        chatList.insertBefore(chatItem, chatList.firstChild);

        // Agregar indicador de mensaje nuevo si no es la conversaci√≥n activa
        if (currentConversationId != chatItem.dataset.conversationId) {
            chatItem.classList.add('has-new-message');
        }
    }

    // Actualizar indicador de conexi√≥n
    function updateConnectionIndicator(connected) {
        const indicator = document.getElementById('connectionIndicator');
        if (connected) {
            indicator.classList.remove('disconnected');
        } else {
            indicator.classList.add('disconnected');
        }
    }

    // Mostrar status temporal
    function showStatus(message, type = 'info') {
        const statusIndicator = document.getElementById('statusIndicator');
        statusIndicator.textContent = message;
        statusIndicator.className = `status-indicator show ${type}`;

        setTimeout(() => {
            statusIndicator.classList.remove('show');
        }, 3000);
    }

    // Mostrar error
    function showError(message) {
        console.error('‚ùå', message);

        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;

        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.appendChild(errorDiv);

        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }

    // Reproducir sonido de notificaci√≥n
    function playNotificationSound() {
        try {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAQABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+D0xW0gBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+D0xW0gBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+D0xW0gBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+D0xW0gBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+D0xW0gBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+D0xW0gBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn==');
            audio.play().catch(() => {}); // Ignorar errores de autoplay
        } catch (e) {
            // Silencioso si no se puede reproducir
        }
    }

    // Mostrar notificaci√≥n desktop
    function showDesktopNotification(clientName, message) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(`Nuevo mensaje de ${clientName}`, {
                body: message.substring(0, 100),
                icon: '/favicon.ico'
            });
        } else if ('Notification' in window && Notification.permission === 'default') {
            // Solicitar permisos si no se han solicitado
            Notification.requestPermission();
        }
    }

    // Actualizar conversaciones manualmente
    function refreshConversations() {
        console.log('üîÑ Actualizando conversaciones...');
        showStatus('Actualizando conversaciones...', 'info');
        requestActiveConversations();
    }

    // Funciones de utilidad para debugging
    window.ChatAdmin = {
        getCurrentConversation: () => currentConversationId,
        getConversationData: () => conversationData,
        isConnected: () => isConnected,
        refreshConversations,
        selectConversation
    };
</script>
{% endblock %}